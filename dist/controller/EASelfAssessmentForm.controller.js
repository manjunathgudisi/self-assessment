sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/IconTabFilter","sap/m/Label","sap/m/RadioButtonGroup","sap/m/RadioButton","sap/m/MessageBox","sap/m/MessageToast","sap/m/MultiComboBox","sap/ui/core/Item","sap/ui/model/json/JSONModel"],function(e,t,s,n,o,i,r,l,a,c){"use strict";return e.extend("easelfassessment.controller.EASelfAssessmentForm",{onInit:function(){this.selectedSkills=[];this._loadData()},_loadData:function(){const e=this.getOwnerComponent().getModel("datamodel");e.setSizeLimit(500);this.getView().setModel(e);e.bindList("/Skills").requestContexts().then(e=>{const t=e.map(e=>e.getObject());this._createIconTabBar(t)}).catch(e=>{i.error("Failed to fetch data: "+e.message)})},_createIconTabBar:function(e){const i=this._groupBySkillType(e);const c=this.byId("idIconTabBar");c.removeAllItems();c.addStyleClass("sapUiSmallMargin");for(let e in i){const m=i[e];const d=new t({text:e,key:e});m.forEach(e=>{const t=new s({text:e.skillDescription}).addStyleClass("sapUiSizeCompact");const i=new n({columns:5,valueState:"Warning",select:this._onRadioButtonSelect.bind(this,e.skillDescription)});i.addButton(new o({text:"Beginner",customData:{key:"level",value:"1"}}));i.addButton(new o({text:"Intermediate",customData:{key:"level",value:"2"}}));i.addButton(new o({text:"Expert",customData:{key:"level",value:"3"}})).addStyleClass("sapUiSmallMargin");d.addContent(t);d.addContent(i)});if(e==="Enterprise Architecture"){const e=new l({placeholder:"Select up to 3 skills",maxWidth:"100%",selectionChange:function(e){const t=e.getSource().getSelectedItems();if(t.length>3){const s=e.getParameter("changedItem");e.getSource().setSelectedItems(t.filter(e=>e!==s));r.show("You can only select up to 3 skills")}},items:m.map(e=>new a({key:e.ID,text:e.skillDescription}))});const t=new s({text:"Please choose top 3 Enterprise Architecture (EA) skills that you want to discuss with your manager for your career development."});t.addStyleClass("sapUiTinyMarginTop");d.addContent(t);d.addContent(e)}c.addItem(d)}},_groupBySkillType:function(e){return e.reduce((e,t)=>{(e[t.skillType]=e[t.skillType]||[]).push(t);return e},{})},_onRadioButtonSelect:function(e,t){const s=t.getSource();const n=s.getSelectedIndex();const o=n+1;const i=this.selectedSkills.findIndex(t=>t.skills===e);if(i!==-1){this.selectedSkills[i].level=o}else{this.selectedSkills.push({skills:e,level:o})}console.log("Current selections:",this.selectedSkills)},_getEaIdAndSubmitSkills:function(e){const t=this.getView().getModel("datamodel");const s=t.bindList("/EAs",null,null,[new sap.ui.model.Filter("empId","EQ",e)]);return s.requestContexts().then(t=>{if(t.length===0){throw new Error("No EA found with Employee ID: "+e)}return t[0].getObject().ID})},onSubmit:function(){const e=this.getView().byId("employeeIDInput").getValue();const t=this.getView().byId("employeeSurname").getValue();const s=this.getView().byId("employeeRegion").getValue();const n=this.getView().byId("employeeEmailt").getValue();const o=this.getView().byId("employeeCountryt").getValue();if(!e||!t||!s){i.error("Please fill in all required fields");return}if(this.selectedSkills.length===0){i.error("Please select at least one skill level");return}i.confirm("Are you sure you want to submit the assessment?",{onClose:e=>{if(e===i.Action.OK){this._submitAssessmentWithDeepInsert()}}})},_submitAssessmentWithDeepInsert:async function(){try{sap.ui.core.BusyIndicator.show(0);const e=this.getView().getModel("datamodel");const t=this._getTableData();const s=[];const n=t.map(e=>{const t={CustomerName:e.customerName,CRMId:e.cRMID,isActive:e.isActiveEngagement,isLead:e.requireShadowing,leadEA:e.shadowEA,comment:e.comment};s.push(t)});const o=this.byId("idIconTabBar");const r=o.getItems().find(e=>e.getText()==="Enterprise Architecture");const a=[];if(r){const e=r.getContent().find(e=>e instanceof l);if(e){const t=e.getSelectedItems();const s=t.map(e=>{const t={skills:e.getText()};a.push(t)})}}const c=[];const m=this.selectedSkills.map(e=>{const t={level:e.level,skills:e.skills};c.push(t)});const d={empId:this.getView().byId("employeeIDInput").getValue(),name:this.getView().byId("employeeSurname").getValue(),region:this.getView().byId("employeeRegion").getValue(),email:this.getView().byId("employeeEmailt").getValue(),country:this.getView().byId("employeeCountryt").getValue(),assignments:s,development:a,experience:c};await this._createEA(e,d);sap.ui.core.BusyIndicator.hide();i.success("Assessment submitted successfully!",{onClose:()=>{this._resetForm()}})}catch(e){sap.ui.core.BusyIndicator.hide();console.error("Submission error:",e);i.error("Error submitting assessment: "+(e.message||"Unknown error occurred"))}},_submitAssessment:async function(){try{sap.ui.core.BusyIndicator.show(0);const e=this.getView().getModel("datamodel");const t={empId:this.getView().byId("employeeIDInput").getValue(),name:this.getView().byId("employeeSurname").getValue(),region:this.getView().byId("employeeRegion").getValue(),email:this.getView().byId("employeeEmailt").getValue(),country:this.getView().byId("employeeCountryt").getValue()};await this._createEA(e,t);const s=await this._getEAIdByEmployeeDetails(e,t);console.log("EA ID obtained:",s);const n=this._getTableData();if(n.length>0){await this._createAssignments(e,s,n);console.log("Assignments created successfully")}if(this.selectedSkills.length>0){await this._createSkills(e,s);console.log("Skills created successfully")}const o=this.byId("idIconTabBar");const r=o.getItems().find(e=>e.getText()==="Enterprise Architecture");if(r){const t=r.getContent().find(e=>e instanceof l);if(t){await this._createSkillDevelopment(e,s,t.getSelectedItems());console.log("Skill Development entries created successfully")}}sap.ui.core.BusyIndicator.hide();i.success("Assessment submitted successfully!",{onClose:()=>{this._resetForm()}})}catch(e){sap.ui.core.BusyIndicator.hide();console.error("Submission error:",e);i.error("Error submitting assessment: "+(e.message||"Unknown error occurred"))}},_createSkillDevelopment:function(e,t,s){return new Promise((n,o)=>{try{const i=s.map(s=>{const n={ea_ID:t,skills:s.getText()};const o="/SkillDevelopment";const i=e.bindList(o);const r=i.create(n);return r.created()});Promise.all(i).then(()=>n()).catch(e=>o(new Error("Failed to create skill development entries: "+e.message)))}catch(e){o(new Error("Error in skill development creation: "+e.message))}})},_createEA:function(e,t){return new Promise(s=>{const n=e.bindList("/EAs");n.create(t);s()})},_getEAIdByEmployeeDetails:function(e,t){return new Promise((s,n)=>{const o=e.bindList("/EAs",null,null,[new sap.ui.model.Filter("empId","EQ",t.empId)]);o.requestContexts().then(e=>{if(e.length>0){const t=e[0].getObject().ID;s(t)}else{n(new Error(`No EA found for Employee ID: ${t.empId}`))}}).catch(e=>{n(new Error("Failed to get EA ID: "+e.message))})})},_createAssignments:function(e,t,s){return new Promise((n,o)=>{try{const i=s.map(s=>{const n={CustomerName:s.customerName,CRMId:s.cRMID,isActive:s.isActiveEngagement,isLead:s.requireShadowing,leadEA:s.shadowEA,comment:s.comment,ea_ID:t};const o=`/EAs(${t})/assignments`;const i=e.bindList(o);const r=i.create(n);return r.created()});Promise.all(i).then(()=>n()).catch(e=>o(new Error("Failed to create assignments: "+e.message)))}catch(e){o(new Error("Error in assignment creation: "+e.message))}})},_createSkills:function(e,t){return new Promise((s,n)=>{try{const o=this.selectedSkills.map(s=>{const n={ea_ID:t,level:s.level,skills:s.skills};const o=`/EAs(${t})/experience`;const i=e.bindList(o);const r=i.create(n);return r.created()});Promise.all(o).then(()=>s()).catch(e=>n(new Error("Failed to create skills: "+e.message)))}catch(e){n(new Error("Error in skill creation: "+e.message))}})},_getTableData:function(){try{const e=this.getView().byId("tableId1");const t=e.getItems();return t.map(e=>{const t=e.getCells();return{customerName:t[0].getValue(),cRMID:t[1].getValue(),isActiveEngagement:t[2].getSelected(),requireShadowing:t[3].getSelected(),shadowEA:t[4].getValue(),comment:t[5].getValue()}}).filter(e=>e.customerName||e.cRMID)}catch(e){console.error("Error in _getTableData:",e);return[]}},_resetForm:function(){try{["employeeIDInput","employeeSurname","employeeRegion","employeeEmailt","employeeCountryt"].forEach(e=>{const t=this.getView().byId(e);if(t){t.setValue("")}});const e=this.getView().byId("tableId1");if(e){e.removeAllItems()}this.selectedSkills=[];const t=this.byId("idIconTabBar");if(t){t.getItems().forEach(e=>{e.getContent().forEach(e=>{if(e instanceof n){e.setSelectedIndex(-1)}})})}}catch(e){console.error("Error in _resetForm:",e);i.error("Error resetting form: "+e.message)}},onAdd:function(e){try{var t=new sap.m.ColumnListItem({cells:[new sap.m.Input,new sap.m.Input,new sap.m.CheckBox,new sap.m.CheckBox,new sap.m.Input,new sap.m.Input]});var s=this.getView().byId("tableId1");s.addItem(t)}catch(e){console.error("Error in onAdd:",e);i.error("Error adding row: "+e.message)}},deleteRow:function(e){try{var t=this.getView().byId("tableId1");t.removeItem(e.getParameter("listItem"))}catch(e){console.error("Error in deleteRow:",e);i.error("Error deleting row: "+e.message)}}})});
//# sourceMappingURL=EASelfAssessmentForm.controller.js.map